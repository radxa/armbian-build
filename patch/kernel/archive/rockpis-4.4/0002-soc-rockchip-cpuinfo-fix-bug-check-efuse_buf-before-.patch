From 2408e49539fcdabadf11f35d061bc6b8a54b93c0 Mon Sep 17 00:00:00 2001
From: Liang Chen <cl@rock-chips.com>
Date: Mon, 8 Feb 2021 16:19:28 +0800
Subject: [PATCH 02/30] soc: rockchip: cpuinfo: fix bug: check efuse_buf before
 use it

Change-Id: I6318eba4e0281d54fe0d429425fce4ab6822eb46
Signed-off-by: Liang Chen <cl@rock-chips.com>
---
 drivers/soc/rockchip/rockchip-cpuinfo.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/soc/rockchip/rockchip-cpuinfo.c b/drivers/soc/rockchip/rockchip-cpuinfo.c
index ebbfafe..2b55c8e 100644
--- a/drivers/soc/rockchip/rockchip-cpuinfo.c
+++ b/drivers/soc/rockchip/rockchip-cpuinfo.c
@@ -29,13 +29,15 @@ static int rockchip_cpuinfo_probe(struct platform_device *pdev)
 	struct device *dev = &pdev->dev;
 	struct nvmem_cell *cell;
 	unsigned char *efuse_buf, buf[16];
-	size_t len;
+	size_t len = 0;
 	int i;
 
 	cell = nvmem_cell_get(dev, "cpu-version");
 	if (!IS_ERR(cell)) {
 		efuse_buf = nvmem_cell_read(cell, &len);
 		nvmem_cell_put(cell);
+		if (IS_ERR(efuse_buf))
+			return PTR_ERR(efuse_buf);
 
 		if (len == 1)
 			rockchip_set_cpu_version(efuse_buf[0]);
@@ -51,6 +53,8 @@ static int rockchip_cpuinfo_probe(struct platform_device *pdev)
 	}
 	efuse_buf = nvmem_cell_read(cell, &len);
 	nvmem_cell_put(cell);
+	if (IS_ERR(efuse_buf))
+		return PTR_ERR(efuse_buf);
 
 	if (len != 16) {
 		kfree(efuse_buf);
-- 
2.7.4

