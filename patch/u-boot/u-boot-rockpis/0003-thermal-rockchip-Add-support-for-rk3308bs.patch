From 2dcd458b65748f5aa22e85f50dff97db81bd15a3 Mon Sep 17 00:00:00 2001
From: Finley Xiao <finley.xiao@rock-chips.com>
Date: Mon, 12 Jul 2021 09:42:30 +0800
Subject: [PATCH 03/19] thermal: rockchip: Add support for rk3308bs

Change-Id: Ifa68843a7fe34ffd5b95f61f45649627de38b1a0
Signed-off-by: Finley Xiao <finley.xiao@rock-chips.com>
(cherry picked from commit 082f45b4b90dad093565d1f04e7f50bd2208e61c)
---
 drivers/thermal/rockchip_thermal.c | 65 ++++++++++++++++++++++++++++++++++++--
 1 file changed, 63 insertions(+), 2 deletions(-)

diff --git a/drivers/thermal/rockchip_thermal.c b/drivers/thermal/rockchip_thermal.c
index 0d48b82..66f8fce 100644
--- a/drivers/thermal/rockchip_thermal.c
+++ b/drivers/thermal/rockchip_thermal.c
@@ -12,6 +12,7 @@
 #include <errno.h>
 #include <syscon.h>
 #include <asm/arch/clock.h>
+#include <asm/arch/cpu.h>
 #include <asm/arch/hardware.h>
 #include <asm/io.h>
 #include <dm/lists.h>
@@ -129,6 +130,9 @@ struct chip_tsadc_table {
 	const struct tsadc_table *id;
 	unsigned int length;
 	u32 data_mask;
+	/* Tsadc is linear, using linear parameters */
+	int knum;
+	int bnum;
 	enum adc_sort_mode mode;
 };
 
@@ -418,6 +422,13 @@ static int tsadc_code_to_temp(struct chip_tsadc_table *table, u32 code,
 	unsigned int num;
 	unsigned long denom;
 
+	if (table->knum) {
+		*temp = (((int)code - table->bnum) * 10000 / table->knum) * 100;
+		if (*temp < MIN_TEMP || *temp > MAX_TEMP)
+			return -EAGAIN;
+		return 0;
+	}
+
 	switch (table->mode) {
 	case ADC_DECREMENT:
 		code &= table->data_mask;
@@ -479,6 +490,9 @@ static u32 tsadc_temp_to_code_v2(struct chip_tsadc_table table,
 	int high, low, mid;
 	u32 error = table.data_mask;
 
+	if (table.knum)
+		return (((temp / 1000) * table.knum) / 1000 + table.bnum);
+
 	low = 0;
 	high = table.length - 1;
 	mid = (high + low) / 2;
@@ -767,10 +781,34 @@ static const struct dm_thermal_ops rockchip_thermal_ops = {
 	.get_temp	= rockchip_thermal_get_temp,
 };
 
+static const struct rockchip_tsadc_chip rk3308bs_tsadc_data = {
+	.chn_id[SENSOR_CPU] = 0, /* cpu sensor is channel 0 */
+	.chn_num = 1, /* 1 channels for tsadc */
+
+	.tshut_mode = TSHUT_MODE_CRU, /* default TSHUT via CRU */
+	.tshut_temp = 95000,
+
+	.tsadc_init = tsadc_init_v2,
+	.tsadc_control = tsadc_control_v2,
+	.tsadc_get_temp = tsadc_get_temp_v2,
+	.irq_ack = tsadc_irq_ack_v3,
+	.set_alarm_temp = tsadc_alarm_temp_v2,
+	.set_tshut_temp = tsadc_tshut_temp_v2,
+	.set_tshut_mode = tsadc_tshut_mode_v2,
+
+	.table = {
+		.knum = 2699,
+		.bnum = 2796,
+		.data_mask = TSADCV2_DATA_MASK,
+		.mode = ADC_INCREMENT,
+	},
+};
+
 static int rockchip_thermal_probe(struct udevice *dev)
 {
 	struct rockchip_thermal_priv *priv = dev_get_priv(dev);
 	struct rockchip_tsadc_chip *tsadc;
+	struct clk clk;
 	int ret, i, shut_temp;
 
 	/* Process 'assigned-{clocks/clock-parents/clock-rates}' properties */
@@ -778,7 +816,23 @@ static int rockchip_thermal_probe(struct udevice *dev)
 	if (ret)
 		printf("%s clk_set_defaults failed %d\n", __func__, ret);
 
-	tsadc = (struct rockchip_tsadc_chip *)dev_get_driver_data(dev);
+	if (soc_is_rk3308bs()) {
+		ret = clk_get_by_name(dev, "tsadc", &clk);
+		if (ret) {
+			printf("%s get tsadc clk fail\n", __func__);
+			return -EINVAL;
+		}
+		ret = clk_set_rate(&clk, 4000000);
+		if (ret < 0) {
+			printf("%s: failed to set tsadc clk rate for %s\n",
+			       __func__, dev_read_name(dev));
+			return -EINVAL;
+		}
+
+		tsadc = (struct rockchip_tsadc_chip *)&rk3308bs_tsadc_data;
+	} else {
+		tsadc = (struct rockchip_tsadc_chip *)dev_get_driver_data(dev);
+	}
 	priv->data = tsadc;
 
 	priv->tshut_mode = dev_read_u32_default(dev,
@@ -809,7 +863,10 @@ static int rockchip_thermal_probe(struct udevice *dev)
 	}
 
 	tsadc->tsadc_control(dev, true);
-	udelay(1000);
+	if (soc_is_rk3308bs())
+		mdelay(3);
+	else
+		udelay(1000);
 
 	debug("tsadc probed successfully\n");
 
@@ -1067,6 +1124,10 @@ static const struct udevice_id rockchip_thermal_match[] = {
 		.data = (ulong)&rk3308_tsadc_data,
 	},
 	{
+		.compatible = "rockchip,rk3308bs-tsadc",
+		.data = (ulong)&rk3308bs_tsadc_data,
+	},
+	{
 		.compatible = "rockchip,rk3328-tsadc",
 		.data = (ulong)&rk3328_tsadc_data,
 	},
-- 
2.7.4

