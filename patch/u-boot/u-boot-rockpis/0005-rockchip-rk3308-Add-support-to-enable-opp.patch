From ced57587ab4c009892562d5c94d29d85113fa075 Mon Sep 17 00:00:00 2001
From: Finley Xiao <finley.xiao@rock-chips.com>
Date: Tue, 14 Sep 2021 19:27:35 +0800
Subject: [PATCH 05/19] rockchip: rk3308: Add support to enable opp

Change-Id: I57a8fa474f3dc5b07602efc59ff5fa19c3be59d5
Signed-off-by: Finley Xiao <finley.xiao@rock-chips.com>
---
 arch/arm/mach-rockchip/rk3308/rk3308.c | 40 +++++++++++++++++++++++++++++++++-
 1 file changed, 39 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-rockchip/rk3308/rk3308.c b/arch/arm/mach-rockchip/rk3308/rk3308.c
index cc9f003..ac856fa 100644
--- a/arch/arm/mach-rockchip/rk3308/rk3308.c
+++ b/arch/arm/mach-rockchip/rk3308/rk3308.c
@@ -206,10 +206,12 @@ int arch_cpu_init(void)
 
 static int fdt_fixup_cpu_opp_table(const void *blob)
 {
-	int opp_node, cpu_node, sub_node;
+	int opp_node, old_opp_node;
+	int cpu_node, sub_node;
 	int len;
 	u32 phandle;
 	u32 *pp;
+	bool is_opp_enabled;
 
 	opp_node = fdt_path_offset(blob, "/rk3308bs-cpu0-opp-table");
 	if (opp_node < 0) {
@@ -237,6 +239,42 @@ static int fdt_fixup_cpu_opp_table(const void *blob)
 		pp[0] = cpu_to_fdt32(phandle);
 	}
 
+	old_opp_node = fdt_path_offset(blob, "/cpu0-opp-table");
+	if (old_opp_node < 0) {
+		printf("Failed to get cpu0-opp-table node\n");
+		return -EINVAL;
+	}
+
+	is_opp_enabled = false;
+	sub_node = fdt_subnode_offset(blob, old_opp_node, "opp-1296000000");
+	if (sub_node >= 0) {
+		if (fdt_stringlist_search(blob, sub_node,
+					  "status", "okay") >= 0)
+			is_opp_enabled = true;
+	}
+
+	sub_node = fdt_subnode_offset(blob, opp_node, "opp-1296000000");
+	if (sub_node >= 0 && is_opp_enabled) {
+		if (fdt_setprop_string((void *)blob, sub_node,
+				       "status", "okay") < 0)
+			printf("Failed to set 1296 okay\n");
+	}
+
+	is_opp_enabled = false;
+	sub_node = fdt_subnode_offset(blob, old_opp_node, "opp-1200000000");
+	if (sub_node >= 0) {
+		if (fdt_stringlist_search(blob, sub_node,
+					  "status", "okay") >= 0)
+			is_opp_enabled = true;
+	}
+
+	sub_node = fdt_subnode_offset(blob, opp_node, "opp-1200000000");
+	if (sub_node >= 0 && is_opp_enabled) {
+		if (fdt_setprop_string((void *)blob, sub_node,
+				       "status", "okay") < 0)
+			printf("Failed to set 1200 okay\n");
+	}
+
 	return 0;
 }
 
-- 
2.7.4

